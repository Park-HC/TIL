# 프로세스, 쓰레드

## 프로세스

- 운영체계로부터 자원을 할당받은 **작업의 단위**
- 메모리에 적재되고 CPU 자원을 할당받아 프로그램이 실행되고 있는 상태
  - 실행되고 있지 않은 프로그램은 그저 저적인 코드 뭉치
- 프로그램이 실행되면 프로세스 인스턴스가 생성되어 Ram에 적재됨

### 프로세스의 4가지 영역

#### 코드 영역

- 정적 영역

- 프로그래머가 작성한 프로그램이 저장되는 영역

#### 데이터 영역

- 정적 영역

- 코드가 실행되면서 사용한 변수나 파일들의 각종 데이터가 모여있는 영역

#### 스택 영역

- 동적 영역

- 함수, 변수 등의 스코프를 관리할 때 사용하는 영역

#### 힙 영역

- 동적 영역

- 동적으로 할당되는 데이터들을 위한 영역(`malloc` 등)



## 스레드

- 어떠한 프로그램(프로세스) 내에서 **실행되는 흐름의 단위**
- 하나의 어플리케이션(프로그램)은 하나 이상의 프로세스를 가지고
  - 하나의 프로세스는 하나 이상의 (메인) 스레드를 가짐
- 스레드는 프로세스 내에서 **스택 영역**만 따로 할당 받고 힙, 코드, 데이터 영역은 공유함
- 스레드가 프로세스 자원을 변경하면 이웃 스레드 역시 그 변경 결과를 즉시 반영 가능
  - 원칙적으로 메모리간 접근이 막힌 프로세스와 다른 점



# 멀티 태스킹

## 멀티태스킹

- 여러 프로세스(프로그램)을 동시에 실행하고 관리하는 것
- OS를 통해 CPU가 작업한느데 필요한 자원(시간)을 프로세스 혹은 쓰레드 간에 나누는 것
- 원칙적으로 프로세스간 메모리 공간 접근은 허용되지 않음
- CPU에서 모든 작업이 동시에 처리되는 것은 아니고 매우 빠른 속도로 번갈아가면서 처리됨



## 멀티 프로세스

- 하나의 어플리케이션을 여러 개의 프로세스로 구성
- 각 프로세스가 하나의 작업을 처리

### 특징

- 높은 안정성
  - 프로세스는 서로 영향을 주기 힘들기에 하나의 프로세스에 문제가 발생해도 다른 프로세스는 무사
- 구현 용이성
- 자원 할당 용이
  - 각 프로세스들이 독립적으로 동작하기 때문
- 프로세스간 통신을 위해 IPC 필요
- 메모리 사용 많음
- Context Switch로 성능 저하 우려



## 멀티 스레드

- 하나의 어플리케이션을 여러개의 스레드로 구성
- 각 스레드가 하나의 작업을 처리
- 단일 스레드로 Network나 DB 등 long-running task를 처리한다면 처리 시간 동안 사용자와 상호 작용이 막힐 수 있으므로 멀티 스레드를 적용함

### 특징

- 응답성이 좋음
  - 프로그램의 일부분(스레드)가 중단 혹은 오류가 발생해도 프로그램이 계속 실행될 수 있음
- 자원 공유 용이
  - 부모 프로세스의 자원과 메모리를 스레드들이 공유함
- 스레드 할당이 프로세스 할당보다 비용이 더 적음
- (멀티 프로세서에서) 각각의 스레드가 다른 프로세서에서 병렬로 수행될 수 있음
- 구현 및 테스트, 디버깅이 어려움
- 스레드 사용이 많으면 오버헤드 발생 위험
- 동기화(전역 변수 사용) 및 교착 상태 발생하지 않도록 주의 필요
- 자식 스레드 하나에서 발생한 문제가 프로세스 전체에 영향을 줄 수 있음



# 추가 요소

## Thread safe

- 여러 스레드가 동시에 사용되어도 안전함(결과가 같음)이 보장되어야 함
- 함수가 전역 변수를 참조한다면 thread safe하지 않을 수 있음
  - thread 간 변수를 공유하기 때문에, 변수가 바뀐다면 이 역시 thread에 반영됨

### 지키기 위한 방법

#### 1. Re-entrancy

- 어떤 함수가 한 스레드에 의해 호출되어 실행 중일 때,
- 다른 스레드가 그 함수를 호출하더라도 그 결과가 각각에게 올바르게 주어져야 함

#### 2. Thread-local storage

- 공유 자원의 사용을 최대한 줄이고 각각의 스레드에서만 접근 가능한 저장소들을 사용해 동시 접근을 막음
- 공유 상태를 피할 수 없을 때, 동기화를 다루기 위해 필요한 방식

#### 3. Mutual exclusion

- 공유 자원을 곡 사용해야 할 경우 해당 자원의 접근을 세마포어 등의 락으로 통제

#### 4. Atomic operations

- 공유 자원에 접근 시 원자 연산을 이용함
- 혹은 '원자적'으로 정의된 접근 방법을 사용해 상호 배제를 구현



## Context Switching

- 여러 프로세스가 돌아가면서 자료를 처리하는 과정
- 동작 중이 프로세스가 대기 중 해당 프로세스의 상태(Context)를 보관하고 대기하다가 다시 실행(다음에 적용할 Task의 상태 값을 읽고 적용)하는 데 필요한 비용(시간)
- Stack 영역만 관리하는 스레드가 Context Switching에서 프로세스보다 많이 경제적임
  - Context Swtiching의 비용
    - Cache 초기화
    - Memory Mapping 초기화
    - Kernel 실행
    - 등등...

### 과정

- Task의 대부분의 정보는 Register에 저장되고 PCB(Process Control Block)으로 관리
- 현재 실행하고 있는 Task의 PCB 정보를 저장(Process Stack, Ready Queue)
- 다음에 실행할 Task의 PCB 정보를 읽어서 Register에 적재
- 그후 CPU가 이전에 진행했던 과정을 연속적으로 수행할 수 있게 함
- 가장 단순하게, generator의 yeild를 예시로 들 수 있음
  - yeild 실행시 해당 함수를 잠시 멈추고 외부 함수를 동작, 그후 다시 해당 함수로 돌아 옴


